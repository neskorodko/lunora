/**
 * –ú–æ–¥—É–ª—å –¥–ª—è —Ä–µ–∂–∏–º—É –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó
 * @module modes/astrology
 */

const { Markup } = require('telegraf');
const { deductCoins, logActivity } = require('../helpers/utils');
const { callOpenAI } = require('../helpers/openai');

/**
 * –†–µ–≥—É–ª—è—Ä–Ω–∏–π –≤–∏—Ä–∞–∑ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–∞—Ç–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ DD.MM.YYYY
 */
const DATE_REGEX = /^(0[1-9]|[12][0-9]|3[01])\.(0[1-9]|1[0-2])\.(19|20)\d\d$/;

/**
 * –†–µ–≥—É–ª—è—Ä–Ω–∏–π –≤–∏—Ä–∞–∑ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —á–∞—Å—É —É —Ñ–æ—Ä–º–∞—Ç—ñ HH:MM
 */
const TIME_REGEX = /^([01]\d|2[0-3]):([0-5]\d)$/;

/**
 * –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó –¥–ª—è –±–æ—Ç–∞
 * @param {Telegraf} bot - –ï–∫–∑–µ–º–ø–ª—è—Ä Telegraf –±–æ—Ç–∞
 */
function setupAstrologyMode(bot) {
  // –ú–µ–Ω—é —Ä–µ–∂–∏–º—É –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó
  const astrologyMenuKeyboard = Markup.keyboard([
    ['üåü –ù–∞—Ç–∞–ª—å–Ω–∞ –∫–∞—Ä—Ç–∞', 'üåì –©–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø'],
    ['üåô –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑–Ω–∞–∫—ñ–≤', 'üìÖ –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑'],
    ['üîÑ –ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é']
  ]).resize();

  // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –¥–ª—è –≤–∏–±–æ—Ä—É –∑–Ω–∞–∫—É –∑–æ–¥—ñ–∞–∫—É
  const zodiacSignsKeyboard = Markup.keyboard([
    ['‚ôà –û–≤–µ–Ω', '‚ôâ –¢–µ–ª–µ—Ü—å', '‚ôä –ë–ª–∏–∑–Ω—é–∫–∏'],
    ['‚ôã –†–∞–∫', '‚ôå –õ–µ–≤', '‚ôç –î—ñ–≤–∞'],
    ['‚ôé –¢–µ—Ä–µ–∑–∏', '‚ôè –°–∫–æ—Ä–ø—ñ–æ–Ω', '‚ôê –°—Ç—Ä—ñ–ª–µ—Ü—å'],
    ['‚ôë –ö–æ–∑–µ—Ä—ñ–≥', '‚ôí –í–æ–¥–æ–ª—ñ–π', '‚ôì –†–∏–±–∏'],
    ['üîÑ –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó']
  ]).resize();

  // –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É —Ä–µ–∂–∏–º—É –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó
  bot.hears('‚ú® –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—è', async (ctx) => {
    ctx.session.mode = 'astrology';
    ctx.session.astrologyData = {}; // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–±'—î–∫—Ç—É –¥–ª—è –¥–∞–Ω–∏—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó
    await ctx.reply('–í–∏ –≤–∏–±—Ä–∞–ª–∏ —Ä–µ–∂–∏–º –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó. –û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É:', astrologyMenuKeyboard);
    logActivity(ctx, '–í—ñ–¥–∫—Ä–∏–≤ —Ä–µ–∂–∏–º –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó');
  });

  // –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –º–µ–Ω—é –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó
  bot.hears('üîÑ –ù–∞–∑–∞–¥ –¥–æ –º–µ–Ω—é –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó', async (ctx) => {
    if (ctx.session.mode !== 'astrology') return;
    
    ctx.session.astrologyData = {}; // –°–∫–∏–¥–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö
    ctx.session.astrologyAction = null; // –°–∫–∏–¥–∞–Ω–Ω—è –¥—ñ—ó
    await ctx.reply('–û–±–µ—Ä—ñ—Ç—å –ø–æ—Å–ª—É–≥—É –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—ó:', astrologyMenuKeyboard);
  });

  // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏
  bot.hears('üåü –ù–∞—Ç–∞–ª—å–Ω–∞ –∫–∞—Ä—Ç–∞', async (ctx) => {
    if (ctx.session.mode !== 'astrology') return;
    
    const COST = 5; // –í–∞—Ä—Ç—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏ - 5 –º–æ–Ω–µ—Ç
    
    if (!deductCoins(ctx, COST)) {
      await ctx.reply(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º–æ–Ω–µ—Ç –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏. –í–∞—Ä—Ç—ñ—Å—Ç—å: ${COST} –º–æ–Ω–µ—Ç. –ü–æ–ø–æ–≤–Ω—ñ—Ç—å –±–∞–ª–∞–Ω—Å —É –º–∞–≥–∞–∑–∏–Ω—ñ.`);
      return;
    }
    
    ctx.session.astrologyAction = 'natal_chart';
    ctx.session.astrologyData = {}; // –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –¥–∞–Ω–∏—Ö
    
    await ctx.reply(`–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏ (–≤–∏—Ç—Ä–∞—á–µ–Ω–æ ${COST} –º–æ–Ω–µ—Ç).
    
–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É –≤–∞—à–æ–≥–æ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ –î–î.–ú–ú.–†–†–†–†
–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 15.06.1990`);
    
    logActivity(ctx, '–ü–æ—á–∞–≤ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏');
  });
  
  // –©–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)
  bot.hears('üåì –©–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø', async (ctx) => {
    if (ctx.session.mode !== 'astrology') return;
    
    ctx.session.astrologyAction = 'daily_horoscope';
    await ctx.reply('–û–±–µ—Ä—ñ—Ç—å —Å–≤—ñ–π –∑–Ω–∞–∫ –∑–æ–¥—ñ–∞–∫—É –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —â–æ–¥–µ–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø—É:', zodiacSignsKeyboard);
    
    logActivity(ctx, '–ó–∞–ø–∏—Ç–∞–≤ —â–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø');
  });
  
  // –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑–Ω–∞–∫—ñ–≤ (2 –º–æ–Ω–µ—Ç–∏)
  bot.hears('üåô –°—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑–Ω–∞–∫—ñ–≤', async (ctx) => {
    if (ctx.session.mode !== 'astrology') return;
    
    const COST = 2; // –í–∞—Ä—Ç—ñ—Å—Ç—å –∞–Ω–∞–ª—ñ–∑—É —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ - 2 –º–æ–Ω–µ—Ç–∏
    
    if (!deductCoins(ctx, COST)) {
      await ctx.reply(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º–æ–Ω–µ—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ. –í–∞—Ä—Ç—ñ—Å—Ç—å: ${COST} –º–æ–Ω–µ—Ç. –ü–æ–ø–æ–≤–Ω—ñ—Ç—å –±–∞–ª–∞–Ω—Å —É –º–∞–≥–∞–∑–∏–Ω—ñ.`);
      return;
    }
    
    ctx.session.astrologyAction = 'compatibility';
    ctx.session.astrologyData = {
      cost: COST
    };
    
    await ctx.reply(`–ê–Ω–∞–ª—ñ–∑ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑–Ω–∞–∫—ñ–≤ (–≤–∏—Ç—Ä–∞—á–µ–Ω–æ ${COST} –º–æ–Ω–µ—Ç).
    
–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—à–∏–π –∑–Ω–∞–∫ –∑–æ–¥—ñ–∞–∫—É:`, zodiacSignsKeyboard);
    
    logActivity(ctx, '–ü–æ—á–∞–≤ –∞–Ω–∞–ª—ñ–∑ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑–Ω–∞–∫—ñ–≤');
  });
  
  // –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ (3 –º–æ–Ω–µ—Ç–∏)
  bot.hears('üìÖ –ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑', async (ctx) => {
    if (ctx.session.mode !== 'astrology') return;
    
    const COST = 3; // –í–∞—Ä—Ç—ñ—Å—Ç—å –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑—É - 3 –º–æ–Ω–µ—Ç–∏
    
    if (!deductCoins(ctx, COST)) {
      await ctx.reply(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º–æ–Ω–µ—Ç –¥–ª—è –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑—É. –í–∞—Ä—Ç—ñ—Å—Ç—å: ${COST} –º–æ–Ω–µ—Ç. –ü–æ–ø–æ–≤–Ω—ñ—Ç—å –±–∞–ª–∞–Ω—Å —É –º–∞–≥–∞–∑–∏–Ω—ñ.`);
      return;
    }
    
    ctx.session.astrologyAction = 'forecast';
    ctx.session.astrologyData = {};
    
    await ctx.reply(`–ê—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –º—ñ—Å—è—Ü—ñ (–≤–∏—Ç—Ä–∞—á–µ–Ω–æ ${COST} –º–æ–Ω–µ—Ç).
    
–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∫–∞–∂—ñ—Ç—å –≤–∞—à—É –¥–∞—Ç—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ –î–î.–ú–ú.–†–†–†–†
–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 15.06.1990`);
    
    logActivity(ctx, '–ü–æ—á–∞–≤ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑—É');
  });
  
  // –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –∑–Ω–∞–∫—ñ–≤ –∑–æ–¥—ñ–∞–∫—É
  bot.hears([
    '‚ôà –û–≤–µ–Ω', '‚ôâ –¢–µ–ª–µ—Ü—å', '‚ôä –ë–ª–∏–∑–Ω—é–∫–∏', '‚ôã –†–∞–∫', '‚ôå –õ–µ–≤', '‚ôç –î—ñ–≤–∞',
    '‚ôé –¢–µ—Ä–µ–∑–∏', '‚ôè –°–∫–æ—Ä–ø—ñ–æ–Ω', '‚ôê –°—Ç—Ä—ñ–ª–µ—Ü—å', '‚ôë –ö–æ–∑–µ—Ä—ñ–≥', '‚ôí –í–æ–¥–æ–ª—ñ–π', '‚ôì –†–∏–±–∏'
  ], async (ctx) => {
    if (ctx.session.mode !== 'astrology') return; 
    
    const sign = ctx.message.text;
    const action = ctx.session.astrologyAction;
    
    if (!action) {
      await ctx.reply('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É –∑ –º–µ–Ω—é.');
      return;
    }
    
    // –©–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø - –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ
    if (action === 'daily_horoscope') {
      try {
        await ctx.reply(`–ì–µ–Ω–µ—Ä—É—é —â–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫—É ${sign}...`);
        
        const prompt = `–¢–∏ - –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –°–∫–ª–∞–¥–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π —â–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫—É ${sign} –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ.
        –í–∫–ª—é—á–∏ –∑–∞–≥–∞–ª—å–Ω—É —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—é –¥–Ω—è, –∞—Å–ø–µ–∫—Ç–∏ —â–æ–¥–æ –∫–∞—Ä'—î—Ä–∏, —Ñ—ñ–Ω–∞–Ω—Å—ñ–≤, –∑–¥–æ—Ä–æ–≤'—è, –ª—é–±–æ–≤—ñ —Ç–∞ –æ—Å–æ–±–∏—Å—Ç–æ–≥–æ —Ä–æ–∑–≤–∏—Ç–∫—É.
        –î–æ–¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –Ω–∞ –¥–µ–Ω—å. –ü–∏—à–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, –≥–ª–∏–±–æ–∫–æ, –∞–ª–µ –¥–æ—Å—Ç—É–ø–Ω–æ.`;
        
        const horoscope = await callOpenAI(prompt);
        await ctx.reply(horoscope);
        
        // –°–∫–∏–¥–∞–Ω–Ω—è –¥—ñ—ó
        ctx.session.astrologyAction = null;
        
        logActivity(ctx, `–û—Ç—Ä–∏–º–∞–≤ —â–æ–¥–µ–Ω–Ω–∏–π –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∑–Ω–∞–∫—É ${sign}`);
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —â–æ–¥–µ–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø—É:', error);
        await ctx.reply('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –≥–æ—Ä–æ—Å–∫–æ–ø—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
      }
      return;
    }
    
    // –ê–Ω–∞–ª—ñ–∑ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ - –ø–æ—Ç—Ä—ñ–±–Ω—ñ –¥–≤–∞ –∑–Ω–∞–∫–∏
    if (action === 'compatibility') {
      const data = ctx.session.astrologyData;
      
      if (!data.firstSign) {
        // –ó–∞–ø–∞–º'—è—Ç–æ–≤—É—î–º–æ –ø–µ—Ä—à–∏–π –∑–Ω–∞–∫
        data.firstSign = sign;
        await ctx.reply(`–ü–µ—Ä—à–∏–π –∑–Ω–∞–∫: ${sign}
        
–¢–µ–ø–µ—Ä –æ–±–µ—Ä—ñ—Ç—å –¥—Ä—É–≥–∏–π –∑–Ω–∞–∫ –∑–æ–¥—ñ–∞–∫—É –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ:`, zodiacSignsKeyboard);
      } else {
        // –ú–∞—î–º–æ –æ–±–∏–¥–≤–∞ –∑–Ω–∞–∫–∏, —Ä–æ–±–∏–º–æ –∞–Ω–∞–ª—ñ–∑
        const firstSign = data.firstSign;
        const secondSign = sign;
        
        try {
          await ctx.reply(`–ê–Ω–∞–ª—ñ–∑—É—é —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å –∑–Ω–∞–∫—ñ–≤ ${firstSign} —Ç–∞ ${secondSign}...`);
          
          const prompt = `–¢–∏ - –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥ –∑ –≤–µ–ª–∏–∫–∏–º –¥–æ—Å–≤—ñ–¥–æ–º. –ó—Ä–æ–±–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –º—ñ–∂ –∑–Ω–∞–∫–∞–º–∏ ${firstSign} —Ç–∞ ${secondSign}.
          –†–æ–∑–±–µ—Ä–∏ —Ç–∞–∫—ñ –∞—Å–ø–µ–∫—Ç–∏:
          - –ó–∞–≥–∞–ª—å–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å —Ç–∞ –ø–æ—Ç–µ–Ω—Ü—ñ–∞–ª –≤—ñ–¥–Ω–æ—Å–∏–Ω
          - –†–æ–º–∞–Ω—Ç–∏—á–Ω–∞ —Ç–∞ –µ–º–æ—Ü—ñ–π–Ω–∞ —Å—É–º—ñ—Å–Ω—ñ—Å—Ç—å
          - –°–µ–∫—Å—É–∞–ª—å–Ω–∞ –≥–∞—Ä–º–æ–Ω—ñ—è
          - –Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–µ –ø–æ—Ä–æ–∑—É–º—ñ–Ω–Ω—è
          - –î–æ–≤–≥–æ—Ç—Ä–∏–≤–∞–ª—ñ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∏
          - –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ —É —Å—Ç–æ—Å—É–Ω–∫–∞—Ö —Ç–∞ —è–∫ —ó—Ö –ø–æ–¥–æ–ª–∞—Ç–∏
          
          –î–∞–π –æ—Ü—ñ–Ω–∫—É —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑–∞ 10-–±–∞–ª—å–Ω–æ—é —à–∫–∞–ª–æ—é –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∞—Å–ø–µ–∫—Ç—É.
          –ü–∏—à–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, –≥–ª–∏–±–æ–∫–æ, –∞–ª–µ –∑—Ä–æ–∑—É–º—ñ–ª–æ –¥–ª—è –ª—é–¥–µ–π –±–µ–∑ –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –∑–Ω–∞–Ω—å.`;
          
          const compatibility = await callOpenAI(prompt);
          await ctx.reply(compatibility);
          
          // –°–∫–∏–¥–∞–Ω–Ω—è –¥—ñ—ó —Ç–∞ –¥–∞–Ω–∏—Ö
          ctx.session.astrologyAction = null;
          ctx.session.astrologyData = {};
          
          logActivity(ctx, `–û—Ç—Ä–∏–º–∞–≤ –∞–Ω–∞–ª—ñ–∑ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑–Ω–∞–∫—ñ–≤ ${firstSign} —ñ ${secondSign}`);
        } catch (error) {
          console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª—ñ–∑—ñ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ:', error);
          await ctx.reply('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª—ñ–∑—ñ —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
          
          // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –º–æ–Ω–µ—Ç–∏ —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏
          ctx.session.user.coins += data.cost;
        }
      }
      return;
    }
  });
  
  // –û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –¥–ª—è –≤–≤–µ–¥–µ–Ω–Ω—è –¥–∞—Ç–∏ —Ç–∞ —á–∞—Å—É
  bot.on('text', async (ctx) => {
    if (ctx.session.mode !== 'astrology') return;
    
    const action = ctx.session.astrologyAction;
    if (!action) return; // –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó –¥—ñ—ó
    
    const text = ctx.message.text;
    const data = ctx.session.astrologyData || {};
    
    // –û–±—Ä–æ–±–∫–∞ –¥–∞—Ç–∏ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏ –∞–±–æ –ø—Ä–æ–≥–Ω–æ–∑—É
    if ((action === 'natal_chart' || action === 'forecast') && !data.birthDate) {
      if (DATE_REGEX.test(text)) {
        // –î–∞—Ç–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ
        data.birthDate = text;
        
        if (action === 'natal_chart') {
          await ctx.reply(`–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${text}
          
–¢–µ–ø–µ—Ä –≤–∫–∞–∂—ñ—Ç—å —á–∞—Å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è —É —Ñ–æ—Ä–º–∞—Ç—ñ –ì–ì:–•–• (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ 14:30)
–Ø–∫—â–æ —Ç–æ—á–Ω–∏–π —á–∞—Å –Ω–µ–≤—ñ–¥–æ–º–∏–π, –≤–∫–∞–∂—ñ—Ç—å –ø—Ä–∏–±–ª–∏–∑–Ω–∏–π –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å "–Ω–µ–≤—ñ–¥–æ–º–æ"`);
        } else if (action === 'forecast') {
          // –î–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞—Ç–∏
          try {
            await ctx.reply(`–ì–µ–Ω–µ—Ä—É—é –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –º—ñ—Å—è—Ü—ñ –¥–ª—è –æ—Å–æ–±–∏, —â–æ –Ω–∞—Ä–æ–¥–∏–ª–∞—Å—è ${data.birthDate}...`);
            
            const prompt = `–¢–∏ - –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥ –∑ –±–∞–≥–∞—Ç–æ—Ä—ñ—á–Ω–∏–º –¥–æ—Å–≤—ñ–¥–æ–º. –°—Ç–≤–æ—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—ñ 3 –º—ñ—Å—è—Ü—ñ –¥–ª—è –ª—é–¥–∏–Ω–∏, —â–æ –Ω–∞—Ä–æ–¥–∏–ª–∞—Å—è ${data.birthDate}.
            
            –ü—Ä–æ–≥–Ω–æ–∑ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏:
            1. –ó–∞–≥–∞–ª—å–Ω—ñ —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—ó —Ç–∞ –∫–ª—é—á–æ–≤—ñ –∫–æ—Å–º—ñ—á–Ω—ñ –≤–ø–ª–∏–≤–∏ –Ω–∞ –ø–µ—Ä—ñ–æ–¥
            2. –û–∫—Ä–µ–º—ñ —Ä–æ–∑–¥—ñ–ª–∏ –ø–æ –º—ñ—Å—è—Ü—è—Ö –∑ —Ç–æ—á–Ω–∏–º–∏ –¥–∞—Ç–∞–º–∏ –≤–∞–∂–ª–∏–≤–∏—Ö –ø–ª–∞–Ω–µ—Ç–∞—Ä–Ω–∏—Ö –∞—Å–ø–µ–∫—Ç—ñ–≤
            3. –î–µ—Ç–∞–ª—å–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∑–∞ —Å—Ñ–µ—Ä–∞–º–∏: –∫–∞—Ä'—î—Ä–∞/—Ä–æ–±–æ—Ç–∞, —Ñ—ñ–Ω–∞–Ω—Å–∏, –∑–¥–æ—Ä–æ–≤'—è, –æ—Å–æ–±–∏—Å—Ç—ñ —Å—Ç–æ—Å—É–Ω–∫–∏
            4. –û—Å–æ–±–ª–∏–≤–æ —Å–ø—Ä–∏—è—Ç–ª–∏–≤—ñ —Ç–∞ –Ω–µ—Å–ø—Ä–∏—è—Ç–ª–∏–≤—ñ –¥–Ω—ñ
            5. –ü—Ä–∞–∫—Ç–∏—á–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è –ø–µ—Ä—ñ–æ–¥—É
            
            –ü–∏—à–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é. –£–Ω–∏–∫–∞–π –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Ñ—Ä–∞–∑, —è–∫—ñ –ø—ñ–¥—Ö–æ–¥—è—Ç—å –≤—Å—ñ–º. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º —ñ –¥–∞–≤–∞–π —á—ñ—Ç–∫—ñ –ø—Ä–æ–≥–Ω–æ–∑–∏ –∑ –ø—Ä–∏–≤'—è–∑–∫–æ—é –¥–æ –¥–∞—Ç.`;
            
            const forecast = await callOpenAI(prompt);
            await ctx.reply(forecast);
            
            // –°–∫–∏–¥–∞–Ω–Ω—è –¥—ñ—ó —Ç–∞ –¥–∞–Ω–∏—Ö
            ctx.session.astrologyAction = null;
            ctx.session.astrologyData = {};
            
            logActivity(ctx, '–û—Ç—Ä–∏–º–∞–≤ –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 3 –º—ñ—Å—è—Ü—ñ');
          } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø—Ä–æ–≥–Ω–æ–∑—É:', error);
            await ctx.reply('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø—Ä–æ–≥–Ω–æ–∑—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
            
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –º–æ–Ω–µ—Ç–∏ —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏ (3 –º–æ–Ω–µ—Ç–∏)
            ctx.session.user.coins += 3;
          }
        }
      } else {
        await ctx.reply('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç–∏. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥–∞—Ç—É —É —Ñ–æ—Ä–º–∞—Ç—ñ –î–î.–ú–ú.–†–†–†–† (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 15.06.1990)');
      }
      return;
    }
    
    // –û–±—Ä–æ–±–∫–∞ —á–∞—Å—É –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏
    if (action === 'natal_chart' && data.birthDate && !data.birthTime) {
      let validTime = true;
      
      if (text.toLowerCase() === '–Ω–µ–≤—ñ–¥–æ–º–æ') {
        data.birthTime = '12:00'; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –ø–æ–ª—É–¥–µ–Ω—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
      } else if (TIME_REGEX.test(text)) {
        data.birthTime = text;
      } else {
        validTime = false;
        await ctx.reply('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —á–∞—Å—É. –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∞—Å —É —Ñ–æ—Ä–º–∞—Ç—ñ –ì–ì:–•–• (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 14:30) –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å "–Ω–µ–≤—ñ–¥–æ–º–æ"');
      }
      
      if (validTime) {
        await ctx.reply(`–ß–∞—Å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.birthTime}
        
–¢–µ–ø–µ—Ä –≤–∫–∞–∂—ñ—Ç—å –º—ñ—Å—Ü–µ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è (–º—ñ—Å—Ç–æ, –∫—Ä–∞—ó–Ω—É)`);
      }
      return;
    }
    
    // –û–±—Ä–æ–±–∫–∞ –º—ñ—Å—Ü—è –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏
    if (action === 'natal_chart' && data.birthDate && data.birthTime && !data.birthPlace) {
      data.birthPlace = text;
      
      try {
        await ctx.reply(`–°—Ç–≤–æ—Ä—é—é –Ω–∞—Ç–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É –¥–ª—è:
        
–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.birthDate}
–ß–∞—Å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.birthTime}
–ú—ñ—Å—Ü–µ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.birthPlace}

–¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –∫—ñ–ª—å–∫–∞ —Ö–≤–∏–ª–∏–Ω...`);
        
        // –¢—É—Ç –º–∞—î –±—É—Ç–∏ –ª–æ–≥—ñ–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏
        // –í —Ä–µ–∞–ª—å–Ω—ñ–π —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º–∏ –± –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏ —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É
        // –∞–±–æ API –¥–ª—è –ø–æ–±—É–¥–æ–≤–∏ —Å–ø—Ä–∞–≤–∂–Ω—å–æ—ó –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏
        
        // –ó–∞–ø–∏—Ç –¥–æ OpenAI –¥–ª—è —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—ó –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏
        const prompt = `–¢–∏ - –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π –∞—Å—Ç—Ä–æ–ª–æ–≥ –∑ –±–∞–≥–∞—Ç–æ—Ä—ñ—á–Ω–∏–º –¥–æ—Å–≤—ñ–¥–æ–º. –°—Ç–≤–æ—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω—É —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—é –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏ –¥–ª—è –ª—é–¥–∏–Ω–∏ –∑ —Ç–∞–∫–∏–º–∏ –¥–∞–Ω–∏–º–∏:
        
        –î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.birthDate}
        –ß–∞—Å –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.birthTime}
        –ú—ñ—Å—Ü–µ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è: ${data.birthPlace}
        
        –ê–Ω–∞–ª—ñ–∑ –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏:
        1. –ó–Ω–∞–∫ —Å–æ–Ω—Ü—è, –º—ñ—Å—è—Ü—è —Ç–∞ –∞—Å—Ü–µ–Ω–¥–µ–Ω—Ç
        2. –ü–æ–ª–æ–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –ø–ª–∞–Ω–µ—Ç –≤ –∑–Ω–∞–∫–∞—Ö —Ç–∞ –¥–æ–º–∞—Ö
        3. –ö–ª—é—á–æ–≤—ñ –∞—Å–ø–µ–∫—Ç–∏ –º—ñ–∂ –ø–ª–∞–Ω–µ—Ç–∞–º–∏
        4. –î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –æ—Å–æ–±–∏—Å—Ç–æ—Å—Ç—ñ —Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä—É
        5. –¢–∞–ª–∞–Ω—Ç–∏ —Ç–∞ —Å–∏–ª—å–Ω—ñ —Å—Ç–æ—Ä–æ–Ω–∏
        6. –ü–æ—Ç–µ–Ω—Ü—ñ–π–Ω—ñ –≤–∏–∫–ª–∏–∫–∏ —Ç–∞ —è–∫ —ó—Ö –ø–æ–¥–æ–ª–∞—Ç–∏
        7. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó —â–æ–¥–æ –∂–∏—Ç—Ç—î–≤–æ–≥–æ —à–ª—è—Ö—É
        
        –ü–∏—à–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω–æ, –∑ –ø—ñ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ —Å–ø—Ä–∏–π–Ω—è—Ç—Ç—è. –£–Ω–∏–∫–∞–π –Ω–∞–¥—Ç–æ —Ç–µ—Ö–Ω—ñ—á–Ω–∏—Ö –∞—Å—Ç—Ä–æ–ª–æ–≥—ñ—á–Ω–∏—Ö —Ç–µ—Ä–º—ñ–Ω—ñ–≤.`;
        
        const interpretation = await callOpenAI(prompt);
        
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—é —á–∞—Å—Ç–∏–Ω–∞–º–∏ —á–µ—Ä–µ–∑ –æ–±–º–µ–∂–µ–Ω–Ω—è Telegram
        const maxLength = 4000;
        for (let i = 0; i < interpretation.length; i += maxLength) {
          await ctx.reply(interpretation.substring(i, i + maxLength));
        }
        
        // –°–∫–∏–¥–∞–Ω–Ω—è –¥—ñ—ó —Ç–∞ –¥–∞–Ω–∏—Ö
        ctx.session.astrologyAction = null;
        ctx.session.astrologyData = {};
        
        logActivity(ctx, '–û—Ç—Ä–∏–º–∞–≤ –Ω–∞—Ç–∞–ª—å–Ω—É –∫–∞—Ä—Ç—É');
      } catch (error) {
        console.error('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏:', error);
        await ctx.reply('–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –Ω–∞—Ç–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∏. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
        
        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –º–æ–Ω–µ—Ç–∏ —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏ (5 –º–æ–Ω–µ—Ç)
        ctx.session.user.coins += 5;
      }
      return;
    }
  });
}

module.exports = {
  setupAstrologyMode
};
